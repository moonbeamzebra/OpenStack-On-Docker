.PHONY: all
all: install_keystone

docker.t:
    sudo apt-get update
    sudo apt-get install -y facter
    sudo apt-get install -y wget
    wget -qO- https://get.docker.com/ | sh
    sudo service docker restart
    touch docker.t

.PHONY: install_docker
install_docker: 

.PHONY: build_openstack_base
build_openstack_base: install_docker
    sudo makepp -C dockerfiles/openstack_base build_image

.PHONY: build_mariadb
build_mariadb: install_docker
    sudo makepp -C dockerfiles/mariadb build_image

.PHONY: install_mariadb
install_mariadb: build_mariadb
    sudo docker run -d -p 3306:3306 --name openstack-mariadb -e MYSQL_ROOT_PASSWORD=lab1 openstack-mariadb
    sleep 15

.PHONY: build_rabbitmq
build_rabbitmq: install_docker
    sudo makepp -C dockerfiles/rabbitmq build_image 

.PHONY: install_rabbitmq
install_rabbitmq: build_rabbitmq
    sudo docker run -d -p 5672:5672 --name openstack-rabbitmq -e RABBIT_PASS=lab1 openstack-rabbitmq 

.PHONY: build_keystone
build_keystone: build_openstack_base
    sudo makepp -C dockerfiles/keystone build_image

.PHONY: install_keystone
install_keystone: build_keystone install_mariadb
    sudo docker run -d --name openstack-keystone -p 5000:5000 -p 35357:35357 -e KEYSTONEDBPASS=lab1 -e ROOTDBPASS=lab1 -e MYSQLHOST=openstack-mariadb --link openstack-mariadb openstack-keystone
    sleep 15

.PHONY: build_horizon
build_horizon: build_openstack_base
    sudo makepp -C dockerfiles/horizon build_image

.PHONY: install_horizon
install_horizon: build_horizon install_keystone
    sudo docker run -d --name openstack-horizon -p 8888:80  -e KEYSTONE_HOST=openstack-keystone -e ADMIN_PASS=lab1  --link openstack-keystone openstack-horizon

.PHONY: clean
clean:
    sudo docker stop $(shell sudo docker ps -a -q)
    sudo docker rm $(shell sudo docker ps -a -q)

.PHONY: purge
purge: clean
    sudo docker rmi $(shell sudo docker images -q)
    sudo apt-get autoremove -y --purge lxc-docker
    sudo rm docker.t
    sudo rm -rf /var/lib/docker
